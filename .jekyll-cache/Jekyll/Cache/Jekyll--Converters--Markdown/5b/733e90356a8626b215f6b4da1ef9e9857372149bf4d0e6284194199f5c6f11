I"<p>이번에는 IP 주소를 더 효율적으로 사용하기 위한 <strong>NAT</strong>에 대해 알아봅시다.</p>

<h1 id="nat란-무엇인가">NAT란 무엇인가?</h1>

<p>IP가 부족해지면서 여러 해결책들이 도입된 것을 이전에 언급하였는데, NAT도 그 중 하나입니다. 하나의 IP를 이용해서 여러 호스트들의 네트워킹을 지원하기 위한 방법이지요. 일반 가정이나 회사(Organization)은 <code class="language-plaintext highlighter-rouge">Private Address</code>(사설 주소)를 많이 사용하게 되는데요. 사설 네트워크 IP주소는 다음과 같이 정해져 있습니다.</p>
<ul>
  <li>10.0.0.0/8</li>
  <li>172.16.0.0/12</li>
  <li>192.168.0.0/16</li>
</ul>

<p>설명하자면, 그 사설 주소를 외부 공인 IP 주소로 또는 그 반대로 translate 해주는 것이 NAT라고 할 수 있습니다. 다음 그림과 같이 Routing이 가능한 하나의 <code class="language-plaintext highlighter-rouge">Stub Network(Private Address Space)</code>의 edge에 NAT 기능이 들어간 <code class="language-plaintext highlighter-rouge">Border Router</code>를 다는 것으로 주로 사용됩니다. Space 내부에서는 <code class="language-plaintext highlighter-rouge">private(local) address</code>, 외부에서는 <code class="language-plaintext highlighter-rouge">public(official) address</code>를 사용하는 것입니다.</p>

<p><img src="/assets/img/network_nat/nat_background.png" alt="nat-background" width="50%" height="50%" /></p>

<p>회사와 같은 곳에서 내부에서는 사설 IP 주소를 통하여 그들끼리 통신하고 회사 밖 인터넷은 회사의 IP로써 통신하는 구조에서 사용된다 볼 수 있겠습니다.</p>

<h1 id="nat는-어떻게-동작할까">NAT는 어떻게 동작할까?</h1>

<p><img src="/assets/img/network_nat/nat_how.png" alt="nat-how" width="50%" height="50%" /></p>

<p>위와 같은 그림으로 설명을 해보겠습니다. PC1과 Web Server와의 통신을 예로 들어보죠.</p>
<ol>
  <li>PC1은 SRC IP에 자신의 사설 주소, DST IP에 Web Server의 IP주소를 적어 packet을 전송합니다.</li>
  <li>패킷은 모뎀과 라우터 R1(Private Address를 가진 Router)를 타고(forwarding) Border Router인 R2에 도달하게 됩니다.</li>
  <li>NAT 기능을 가진 R2는 SRC IP의 192.168.10.10을 Public IP인 209.165.200.226으로 <code class="language-plaintext highlighter-rouge">Mapping</code> 합니다(바꿔줍니다).</li>
  <li>그 패킷은 여러 Router를 타고 Web Server에 도달합니다. 그 후, 서버는 SRC와 DST를 바꿔 클라이언트(PC1)으로 packet을 전송합니다.(DST는 Public인 209.165.200.226가 되겠죠?)</li>
  <li>R2는 도달한 패킷을 보고 <code class="language-plaintext highlighter-rouge">NAT table</code>을 보고 아까 Mapping 하였던 entry를 확인해 다시 사설 주소로 바꿔줍니다.</li>
  <li>packet은 다시 타고 타서 PC1에 도착하게 됩니다.</li>
</ol>

<p>간단하죠? 다만 이러한 과정은 ‘packet 송신 과정 중 <strong>SRC IP와 DST IP는 절대 바뀌어서는 안된다’</strong>는 규약을 어기게 되는 문제가 있습니다. 그렇지만 IP가 부족한 것이 먼저라 감수해야 하는 문제인 것 같습니다.:cry: 조금 더 구체적으로 NAT의 원리를 알아보도록 합시다.</p>

<h2 id="static-nat">STATIC NAT</h2>

<p>정적 방식은 단순히 사설 주소와 공인 주소를 <code class="language-plaintext highlighter-rouge">Mapping Table</code>에서 <code class="language-plaintext highlighter-rouge">one-to-one mapping</code>하는 것입니다. 그렇기 때문에 어떤 사설 IP가 어떤 공인 IP와 매칭하는지가 모두 미리 세팅되어 있어야 합니다. 해야 할 일이 확실히 많은 대역 서버 같은 경우 이와 같은 방식을 사용하는 것이 유리할 수 있는 것이지요.</p>

<h2 id="dynamic-nat">DYNAMIC NAT</h2>

<p><img src="/assets/img/network_nat/nat_pool.png" alt="nat-pool" width="50%" height="50%" /></p>

<p>그러나, 우리는 대부분 정적인 방식보다 동적인 방식에 더 효율성을 느낍니다. 동적 방식은 보유하고 있는 공인 IP 주소의 <code class="language-plaintext highlighter-rouge">Pool</code>에서 호스트의 요청이 올 경우 동적으로 IP를 할당해 줍니다. 아무래도 정적인 방식은 하나의 공인 IP로 호스트들의 요청이 동시에 쏟아지게 되면 하나를 제외한 나머지 호스트들이 놀고 있어야 할텐데, 동적인 방식은 정해진 게 없어 남은 공인 IP를 할당해주면 되기 때문에 조금 더 대처에 유연합니다.</p>

<h1 id="port-address-translationpat">PORT ADDRESS TRANSLATION(PAT)</h1>

<p><img src="/assets/img/network_nat/pat_example.png" alt="pat-example" width="70%" height="70%" /></p>

<p>그렇다 하더라도 STATIC이든 DYNAMIC이든 결국 공인 IP 주소가 결국 호스트의 개수보다 적을 수 밖에 없고, 이 때문에 동시에 들어오는 요청들을 모두 처리할 수가 없게 됩니다. 그렇다면 부족한 IP 주소를 해결하고자 하는 NAT의 취지마저 한 끝도 달라진 게 없는데요? 그래서 우리는 바로 <code class="language-plaintext highlighter-rouge">Port</code> 번호를 사용하게 됩니다. 동일한 IP를 여러 호스트들에게 할당 해주더라도 여기에 각자의 Port 번호를 붙여 각각을 구분하는 것이지요! 그것이 바로 NAT의 확장자인 <code class="language-plaintext highlighter-rouge">PAT</code>인 것입니다. 네트워크 통신에 있어 각각의 <code class="language-plaintext highlighter-rouge">Connection</code>을 구분하는 요소에는 최소한 아래와 같은 5가지가 있습니다.</p>

<ol>
  <li>Source IP</li>
  <li>Destination IP</li>
  <li>Source Port Number</li>
  <li>Destination Port Number</li>
  <li>Protocol</li>
</ol>

<p>이들을 전문 용어로 <code class="language-plaintext highlighter-rouge">5 Tuples</code>라고 칭합니다. 이와 같은 특성을 이용하여 Port 번호로 서로 독립적인 통신 관계를 유지할 수 있는 것입니다. 물론 기본적으로 각각의 계층은 독립적이야 하는 규약에서 벗어나 3계층(IP)에서 4계층(TCP Port)를 사용하는 것인데요. 이 또한, NAT와 마찬가지로 PAT 또한 IP 부족의 문제로 인해 어쩔 수 없는 것이라 합니다.:sweat_smile: 만약 서로 다른 장비가 같은 Port 번호를 사용하는 경우가 있더라도 NAT 장비가 Port 번호를 임의적으로 변경하여 처리합니다. 그렇기 때문에 항상 다른 Port 번호를 보장하게 되는 것입니다. PAT는 오늘날 대부분의 Router들이 제공하며 <code class="language-plaintext highlighter-rouge">NAT overload</code> 또는 <code class="language-plaintext highlighter-rouge">IP masquerading</code>이라 불리기도 합니다. 또한, 실제로는 위와 같은 <code class="language-plaintext highlighter-rouge">/</code> 형태가 아닌 <code class="language-plaintext highlighter-rouge">:</code> 형태를 사용합니다. (ex. 128.143.71.21:2100)</p>

<h3 id="-port-forwarding">+ PORT FORWARDING</h3>

<ul>
  <li>번외</li>
  <li>예를 들어 ICMP처럼 4 계층의 Port Number를 사용하지 않는 패킷들은 PAT에서 조금은 다르게 동작합니다.</li>
</ul>

:ET