I"£.<p>ì´ë²ˆì—ëŠ” <strong>Condition Variables</strong>ì— ëŒ€í•´ ì•Œì•„ë³´ë„ë¡ í•©ì‹œë‹¤.</p>

<h1 id="condition-variabelsë€-ë¬´ì—‡ì¼ê¹Œ">Condition Variabelsë€ ë¬´ì—‡ì¼ê¹Œ?</h1>

<p>â€™'â€™c
void *child(void *arg) {
    printf(â€œchild\nâ€);
    done = 1;
    return NULL;
}
â€¦
Pthread_create(&amp;c, NULL, child, NULL);
while (done == 0)
; // spin
â€˜â€™â€™</p>

<p>ìœ„ì˜ ì˜ˆì‹œì—ì„œëŠ” childê°€ í•´ì•¼í•  ì¼ì„ ë§ˆë¬´ë¦¬í•˜ë©´ doneì´ë¼ëŠ” ê³µìœ  ë³€ìˆ˜ë¡œ ì¢…ë£Œë¥¼ ì•Œë¦¬ê³  ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” ìš°ë¦¬ê°€ ì´ì „ì— lockì—ì„œ ê³µë¶€í–ˆë˜ spin ë°©ë²•ìœ¼ë¡œ ì´ ìŠ¤ë ˆë“œì˜ ì‹ í˜¸ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤. ê²°êµ­ ë¶€ëª¨ ìŠ¤ë ˆë“œ, ì¦‰ ì´ ìƒí™©ì—ì„œ ë©”ì¸ ìŠ¤ë ˆë“œëŠ” ì˜ë¯¸ ì—†ëŠ” ë°˜ë³µë¬¸(spin)ì„ ì‹¤í–‰ì‹œí‚¤ë©° ê¸°ë‹¤ë¦¬ê³  ìˆëŠ” ê²ƒì´ì£ . ì´ëŠ” ì—„ì²­ë‚œ CPUì˜ ë‚­ë¹„ê°€ ì•„ë‹ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!:triumph: Single-CPUë¼ë©´ ë‚­ë¹„ì˜ íš¨ê³¼ê°€ ë”ìš± ì²´ê°ë˜ê² ì£ ?? ë”°ë¼ì„œ ì´ spinì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ê¸°ë‹¤ë¦¬ê³  ìˆëŠ” ìŠ¤ë ˆë“œë¥¼ <code class="language-plaintext highlighter-rouge">Sleeping State</code> ì „í™˜í•˜ê¸° ìœ„í•´ ìš°ë¦¬ëŠ” <code class="language-plaintext highlighter-rouge">Condition Variable</code>ì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ê²ë‹ˆë‹¤.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pthread_cond_wait</span><span class="p">(</span><span class="n">pthread_cond_t</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">m</span><span class="p">);</span>
<span class="n">pthread_cond_signal</span><span class="p">(</span><span class="n">pthread_cond_t</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
</code></pre></div></div>

<p>Condition Variableì€ í•˜ë‚˜ì˜ ëª…ì‹œì ì¸ <code class="language-plaintext highlighter-rouge">Queue</code>ì…ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">wait()</code> í•¨ìˆ˜ëŠ” ìœ„ì—ì„œ ì„¤ëª…í•œëŒ€ë¡œ ê¸°ë‹¤ë ¤ì•¼ í•  ìŠ¤ë ˆë“œê°€ Sleeping State, ì •í™•íˆëŠ” ìŠ¤ë ˆë“œë¥¼ Queueì— ë„£ìŠµë‹ˆë‹¤. â€˜signal()â€™ í•¨ìˆ˜ëŠ” wait()ìœ¼ë¡œ ê¸°ë‹¤ë¦¬ê³  ìˆëŠ” ìŠ¤ë ˆë“œì—ê²Œ ì‹ í˜¸ë¥¼ ì¤Œìœ¼ë¡œì¨ <code class="language-plaintext highlighter-rouge">Ready State</code>, ì¦‰ ìŠ¤ë ˆë“œë¥¼ ê¹¨ìš°ëŠ” ê²ƒì´ì£ . ì¼ë°˜ì ì¸ ì‚¬ìš©ë²•ì˜ ì˜ˆì‹œëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pthread_mutex_t</span> <span class="n">m</span> <span class="o">=</span> <span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
    <span class="n">pthread_cond_t</span> <span class="n">c</span> <span class="o">=</span> <span class="n">PTHREAD_COND_INITIALIZER</span><span class="p">;</span>   

<span class="kt">void</span> <span class="nf">thr_exit</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">);</span> 
    <span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">Pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
    <span class="n">thread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">child</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">"child</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
   <span class="n">thr_exit</span><span class="p">();</span>
   <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">thr_join</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">done</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">Pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
    <span class="n">Pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>   

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"parent: begin</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">pthread_t</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">Pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">thr_join</span><span class="p">();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"parent: end</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Pthread_cond_waití•¨ìˆ˜ì˜ ê°€ì¥ í° íŠ¹ì§•ì€ ê¸°ë‹¤ë¦¬ëŠ” ìƒíƒœì— ë“¤ì–´ê°€ë©´ì„œ <strong>ì¼ì‹œì ìœ¼ë¡œ Lockì„ release í•œ ë’¤ signalì„ í†µí•´ ê¹¼ì„ ë•Œ ë‹¤ì‹œ lockì„ ê°€ì§€ëŠ” ê²ƒì…ë‹ˆë‹¤.</strong> ì™œëƒí•˜ë©´ Lockì„ ê±´ ìƒíƒœë¡œ ê¸°ë‹¤ë¦¬ë©´ ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ signalì„ ë³´ë‚¼ ì—¬ì§€ì£¼ì°¨ ì¤„ ìˆ˜ ì—†ê¸° ë•Œë¬¸ì´ì£ . ì¶”ê°€ì ìœ¼ë¡œ ì˜ë¬¸ì ì„ ê°€ì§ˆ ìˆ˜ ìˆëŠ” ì§ˆë¬¸ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<p>Q. ì™œ wait/signal ì „ì— <code class="language-plaintext highlighter-rouge">mutex_lock</code>ì„ ê±¸ì–´ì•¼ í•˜ëŠ”ê°€?</p>

<p>A. <code class="language-plaintext highlighter-rouge">Race Condition</code>ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ì„œì…ë‹ˆë‹¤. ê°™ì€ cond_të¥¼ ê³µìœ í•˜ëŠ” waitê³¼ signalì´ í•¨ê»˜ ì¼ì–´ë‚˜ë©´ ë ê¹Œìš”?:joy:</p>

<p>Q. ë¬´ì—‡ ë•Œë¬¸ì— doneì´ë¼ëŠ” static variableì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ê°€?</p>

<p>A. ë§Œì•½ì— waitì „ì— signalì´ í˜¸ì¶œ ë˜ì—ˆë‹¤ê³  ìƒê°í•œë‹¤ë©´, waitì€ ì˜¤ì§€ ì•ŠëŠ” signalì„ ë¬´í•œí•˜ê²Œ ê¸°ë‹¤ë ¤ì•¼ í•  ê²ë‹ˆë‹¤.</p>

<p>Q. ê·¸ë ‡ë‹¤ë©´ ì™œ doneì„ í™•ì¸í•˜ëŠ”ë° whileë¬¸ìœ¼ë¡œ ë°˜ë³µì ìœ¼ë¡œ í™•ì¸í•˜ëŠ”ê°€?</p>

<p>A. ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ wait</p>

<h1 id="producerconsumerbounded-buffer-problem">Producer/Consumer(Bounded Buffer) Problem</h1>

<p>ì•ìœ¼ë¡œë¥¼ ê³µë¶€í•˜ê¸° ìœ„í•´ ìœ ëª…í•œ <code class="language-plaintext highlighter-rouge">Producer/Consumer Problem</code>ì„ ì•Œì•„ë´…ì‹œë‹¤. ë§¤ìš° ê°„ë‹¨í•©ë‹¤. Producerì€ bufferì— ì•„ì´í…œì„ ê°€ì ¸ë‹¤ ë†“ê³  consumerì€ ì´ itemì„ ê°€ì ¸ê°€ëŠ” ê²ƒì…ë‹ˆë‹¤.(ì½ê¸° ë° ì‚­ì œ) ë‹¹ì—°í•˜ì§€ë§Œ ì´ bufferì€ ëª¨ë“  ìŠ¤ë ˆë“œì˜ shared resourceê² ì£ ?. ë¨¼ì € ë²„í¼ê°€ í•˜ë‚˜ì¸ ê²½ìš°ì˜ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 
<span class="kt">int</span> <span class="n">buffer</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//1ì´ë©´ itmeì´ ì°¨ìˆê³ , 0ì´ë©´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</span>

<span class="kt">void</span> <span class="nf">put</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">producer</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loops</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">put</span><span class="p">(</span><span class="n">i</span><span class="p">);</span> 
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">consumer</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">get</span><span class="p">();</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ì•Œê³  ë„˜ì–´ê°€ì•¼ í•  ê²ƒì€ ì´ ë¬¸ì œì—ì„œ producerì˜ putê³¼ producerì˜ getì´ ë™ì‹œì— ì¼ì–´ë‚˜ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•´ <code class="language-plaintext highlighter-rouge">lock</code>ìœ¼ë¡œ ê°ì‹¸ì¤˜ì•¼ í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ë˜ í•˜ë‚˜ëŠ”, producerê³¼ ì•„ì´í…œì„ ë„£ì–´ì£¼ê³ (put) ë‚˜ì„œì•¼ consumerê°€ ê°€ì ¸ê°ˆ ìˆ˜(get) ìˆê² ì£ ? ê·¸ë˜ì„œ static variableì¸ <code class="language-plaintext highlighter-rouge">count</code>ê°€ í•„ìš”í•œ ê²ƒì…ë‹ˆë‹¤.</p>

<p>ë¨¼ì € ì²« ë²ˆì§¸ë¡œ, <strong>Single Condition Variable</strong>ê³¼ <strong>If statement</strong>ì„ ì´ìš©í•˜ì—¬ êµ¬í˜„í•´ë³´ì.</p>

:ET